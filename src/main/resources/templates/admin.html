<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>User List</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script
            src="https://code.jquery.com/jquery-3.5.1.js"
            integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
            crossorigin="anonymous"></script>
</head>
<body>
<div>
    <header class="navbar navbar-dark bg-dark">
        <div class="text-block" style="margin-left: 20px">
            <span class="navbar-text text-white" ><b id="usernamelabel" sec:authentication="name"  ></b></span>
            <span class="navbar-text text-white">with roles:</span>
            <span class="navbar-text text-white" id="adminRoles"></span>
<!--                  sec:authentication="principal.authorities"-->
        </div>
        <a href="/logout" class="btn btn-dark text-muted" role="button">Logout</a>
    </header>
    <div class="row">
        <aside class="col-md-2" style="padding-top: 20px">
            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <a class="nav-link active" id="v-pills-Admin-tab" data-toggle="pill" href="#v-pills-Admin" role="tab"
                aria-controls="v-pills-Admin" aria-selected="true">Admin</a>
                <a class="nav-link" id="v-pills-User-tab" data-toggle="pill" href="#v-pills-User" role="tab"
                   aria-controls="v-pills-User" aria-selected="false">User</a>
            </div>
        </aside>
        <section class="col-md-10 h-100" style="background-color: #f2f2f2">
            <div class="tab-content" id="v-pills-tabContent">
                <div class="tab-pane fade show active" id="v-pills-Admin" role="tabpanel"
                     aria-labelledby="v-pills-Admin-tab">
                    <div class="tab-content" style="padding: 20px">
                        <h1>Admin panel</h1>
                        <nav>
                            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                                <a class="nav-item nav-link active" id="nav-Users-tab" data-toggle="tab"
                                   href="#nav-Users" role="tab" aria-controls="nav-Users"
                                   aria-selected="true">Users table</a>
                                <a class="nav-link" id="nav-newUser-tab" data-toggle="tab"
                                   href="#nav-newUser" role="tab" aria-controls="nav-newUser"
                                aria-selected="false">New User</a>
                            </div>
                        </nav>
                        <div class="tab-content" id="nav-Content">
                            <div class="tab-pane fade show active" id="nav-Users" role="tabpanel"
                                 aria-labelledby="nav-Users-tab">
                                <div class="panel panel-default">
                                    <div class="panel-heading" style="padding: 10px">
                                        <h5>All Users</h5>
                                    </div>
                                    <div class="panel-body bg-white" style="padding: 20px">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                            <tr>
                                                <!--                                    <th>ID</th>-->
                                                <td>First Name</td>
                                                <td>Last Name</td>
                                                <td>Username</td>
                                                <td>Password</td>
                                                <td>Date</td>
<!--                                                <td>Email</td>-->
                                                <th>Role</th>
                                                <th>Edit</th>
                                                <th>Delete</th>
                                            </tr>
                                            </thead>
                                            <tbody id="rows">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="nav-newUser" role="tabpanel"
                                 aria-labelledby="nav-newUser-tab">
                                <div class="panel panel-default">
                                    <div class="panel-heading" style="padding: 10px">
                                        <h5>Add new User</h5>
                                    </div>
                                    <div class="panel-body bg-white" style="padding: 20px">
                                        <div class="d-flex align-items-center flex-column justify-content-center h-100">
                                            <form id="formNewUser">
                                                <div class="form-group">
                                                    <label for="formFirstName"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>First Name</b>
                                                    </label>
                                                    <input type="text" class="form-control" name="firstName"
                                                           id="formFirstName" placeholder="Enter First name">
                                                </div>
                                                <div class="form-group">
                                                    <label for="formLastName"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>Last name</b>
                                                    </label>
                                                    <input type="text" class="form-control" name="lastName"
                                                           id="formLastName" placeholder="Enter Last name">
                                                </div>
                                                <div class="form-group">
                                                    <label for="date"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>Date</b>
                                                    </label>
                                                    <input type="text" class="form-control" name="date"
                                                           id="date" placeholder="Enter date">
                                                </div>
                                                <div class="form-group">
                                                    <label for="name"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>Name</b>
                                                    </label>
                                                    <input type="text" class="form-control" name="name"
                                                           id="name" placeholder="Enter name">
                                                </div>
                                                <div class="form-group">
                                                    <label for="password"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>Password</b>
                                                    </label>
                                                    <input type="text" class="form-control" name="password"
                                                           id="password" placeholder="Enter password">
                                                </div>
                                                <div class="form-group">
                                                    <label for="roleSelect"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>Role</b>
                                                    </label>
                                                    <select multiple class="form-control" id="roleSelect">
                                                        <option>ADMIN</option>
                                                        <option>USER</option>
                                                        <option>ANNON</option>
                                                    </select>
                                                </div>
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <input type="button" class="btn btn-success" id="submitNewUser" value="Add new user">
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="v-pills-User" role="tabpanel"
                     aria-labelledby="v-pills-User-tab">
                    <div class="tab-content" style="padding: 20px">
                        <h1>User information-page</h1>
                        <div class="panel panel-default">
                            <div class="panel-heading" style="padding: 10px">
                                <h5>About User</h5>
                            </div>
                            <div class="panel-body bg-white" style="padding: 20px">
                                <table class="table table-striped table-hover">
                                    <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Age</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                    </tr>
                                    </thead>
                                    <tbody id="userRows">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
<script type="text/javascript">
    let stepid;
        let RestGetList = function () {
            $.ajax({
                type: "GET",
                url: "http://localhost:8080/admin/userlist",
                dataType: 'json',
                async: true,
                success: function (data) {
                    for (let step = 0; step < data.length; step++) {
                        let auth = "";
                        for (let pop = 0; pop < data[step]["authorities"].length; pop++) {
                            auth += data[step]["authorities"][pop].authority + ",";
                        }

                        document.getElementById("rows").innerHTML +=
                            `<tr>
<td id="${step}fn" >${data[step].firstName}</td>
<td id="${step}ln">${data[step].lastName}</td>
<td id="${step}un">${data[step].username}</td>
<td id="${step}pa">${data[step].password}</td>
<td id="${step}da">${data[step].date}</td>
<td id="${step}ro">${auth}</td>
<td>
    <button type="button" class="btn btn-info" role="button" data-toggle="modal" data-target="#modal" id="editStartbtn"
     data-edit="${step}" onclick="editPage(${step})">edit</button>
    <div class="modal fade" id="modal" tabIndex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabel">Edit User</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center flex-column justify-content-center h-100">
                        <form id="EditForm" action="">
                            <div class="form-group">
                                <label for="formFirstName"
                                    class="d-flex align-items-center justify-content-center">
                                    <b>First Name</b>
                                </label>
                                <input type="text" class="form-control"
                                     name="firstName"
                                     id="EditFirstName"
                                     placeholder="Enter First name"
                                     value="">
                            </div>
                            <div class="form-group">
                                                    <label for="lastName"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>Last name</b>
                                                    </label>
                                                    <input type="text" class="form-control"
                                                           name="lastName"
                                                           id="EditLastName"
                                                           placeholder="Enter Last name">
                                                </div>
                                                <div class="form-group">
                                                    <label for="date"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>Date</b>
                                                    </label>
                                                    <input type="text" class="form-control"
                                                           name="date"
                                                           id="Editdate"
                                                           placeholder="Enter date">
                                                </div>
                                                    <div class="form-group">
                                                        <label for="name"
                                                               class="d-flex align-items-center justify-content-center">
                                                            <b>Name</b>
                                                        </label>
                                                        <input type="text" class="form-control disabled"
                                                               name="name"
                                                               id="Editname"
                                                               placeholder="Enter name">
                                                    </div>
                                                <div class="form-group">
                                                    <label for="password"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>Password</b>
                                                    </label>
                                                    <input type="text" class="form-control"
                                                           name="password"
                                                           id="Editpassword"
                                                           placeholder="Enter password">
                                                </div>
                                                <div class="form-group">
                                                    <label for="roleSelect"
                                                           class="d-flex align-items-center justify-content-center">
                                                        <b>Role</b>
                                                    </label>
                                                    <select multiple class="form-control"
                                                            id="EditRoleSelect">
                                                        <option>ADMIN</option>
                                                        <option>USER</option>
                                                        <option>ANNON</option>
                                                    </select>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                        data-dismiss="modal">Close</button>
                                        <button type="button" class="btn bg-primary text-white"
                                         role="button" onclick="RESTEdit()" data-dismiss="modal"
                                         >Edit</button>
                                    </div>
            </div>
        </div>
    </div>
</td>
<td>
<button type="button" class="btn btn-danger" role="button" data-toggle="modal" data-target="#modalDelete" data-delete="${step}"
onclick="delPage(${step})">delete</button>
<div class="modal fade" id="modalDelete" tabIndex="-1" role="dialog" aria-labelledby="modalLabel"
                                 aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="ModalDelLabel">Delete User</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="d-flex align-items-center flex-column justify-content-center h-100">
                                                <form action="/admin/user/">
                                                    <fieldset disabled>
                                                        <div class="form-group">
                                                            <label for="formFirstName"
                                                                   class="d-flex align-items-center justify-content-center">
                                                                <b>First Name</b>
                                                            </label>
                                                            <input type="text" class="form-control"
                                                                   name="firstName"
                                                                   id="DelfirstName"
                                                                   placeholder="Enter First name">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="lastName"
                                                                   class="d-flex align-items-center justify-content-center">
                                                                <b>Last name</b>
                                                            </label>
                                                            <input type="text" class="form-control"
                                                                   name="lastName"
                                                                   id="DellastName"
                                                                   placeholder="Enter Last name">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="date"
                                                                   class="d-flex align-items-center justify-content-center">
                                                                <b>Date</b>
                                                            </label>
                                                            <input type="text" class="form-control"
                                                                   name="date"
                                                                   id="Deldate"
                                                                   placeholder="Enter date">
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="name"
                                                                   class="d-flex align-items-center justify-content-center">
                                                                <b>Name</b>
                                                            </label>
                                                            <input type="text"
                                                                   class="form-control disabled"
                                                                   name="name"
                                                                   id="Delname"
                                                                   placeholder="Enter name"
                                                                   value="admin">
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="password"
                                                                   class="d-flex align-items-center justify-content-center">
                                                                <b>Password</b>
                                                            </label>
                                                            <input type="text" class="form-control"
                                                                   name="password"
                                                                   id="Delpassword"
                                                                   placeholder="Enter password">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="roleSelect"
                                                                   class="d-flex align-items-center justify-content-center">
                                                                <b>Role</b>
                                                            </label>
                                                            <select multiple class="form-control"
                                                                    id="DelRoleSelect">
                                                                <option>ADMIN</option>
                                                                <option>USER</option>
                                                                <option>ANNON</option>
                                                            </select>
                                                        </div>
                                                    </fieldset>
                                                </form>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                            <button type="button" class="btn btn-primary" role="button" id="btnDelete"
                                            onclick="RESTDelete()" data-dismiss="modal">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
</td>
            </tr>
            `

                    }

                },
                error: function (jqXHR) {
                    alert(jqXHR.status + ' ' + jqXHR.responseText);
                }
            });
        }
        let RestGetUser = function () {
            $.ajax({
                type: "GET",
                url: "http://localhost:8080/user/" + document.getElementById("usernamelabel").innerText,
                dataType: 'json',
                async: true,
                success: function (data) {

                    let auth = "";
                    for (let pop = 0; pop < data["authorities"].length; pop++) {
                        auth += data["authorities"][pop].authority;
                    }

                    document.getElementById("userRows").innerHTML +=
                        `<tr>
<td >${data.firstName}</td>
<td >${data.lastName}</td>
<td >${data.username}</td>
<td >${data.password}</td>
<td >${data.date}</td>
<td >${auth}</td>
            </tr>`

                },
                error: function (jqXHR) {
                    alert(jqXHR.status + ' ' + jqXHR.responseText);
                }
            });
        }
        $('#submitNewUser').click(function () {
            function redirect(){window.location = 'http://localhost:8080/admin';}
            redirect()
            RestGetList()
                let JSONObject = {
                    'firstName': $('#formFirstName').val(),
                    'lastName': $('#formLastName').val(),
                    'date': $('#date').val(),
                    'name': $('#name').val(),
                    'password':  $('#password').val(),
                    // 'roles': ""//$('#roleSelect').val(),
                };

                $.ajax({
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    url: "http://localhost:8080/admin/userlist",
                    data: JSON.stringify(JSONObject),
                    dataType: 'json',
                    cache: false,
                    processData: false,
                    async: true,
                    success: function (result) {
                        console.log("done add")
                    },
                    error: function (jqXHR) {
                        alert(jqXHR.status + ' ' + jqXHR.responseText)
                    }
                });
        })
    function editPage(step) {

        console.log($("#" + step + "fn").text())

        $('#EditFirstName').val($("#" + step + "fn").text())
        $('#EditLastName').val($("#" + step + "ln").text())
        $('#Editdate').val($("#" + step + "da").text())
        $('#Editname').val($("#" + step + "un").text())
        $('#Editpassword').val($("#" + step + "pa").text())
        // $('#EditRoleSelect').val($("#" + step + "ro").text())
        console.log(step)
        stepid = step
    }

    function delPage(step) {
        $('#DelfirstName').val($("#" + step + "fn").text())
        $('#DellastName').val($("#" + step + "ln").text())
        $('#Deldate').val($("#" + step + "da").text())
        $('#Delname').val($("#" + step + "un").text())
        $('#Delpassword').val($("#" + step + "pa").text())
        // $('#DelRoleSelect').val($("#" + step + "ro").text())
        console.log(step)
        stepid = step
    }

        function RESTEdit () {
            RestGetList();
            console.log(stepid)
            let JSONObject = {
                'firstName': $('#EditFirstName').val(),
                'lastName': $('#EditLastName').val(),
                'date': $('#Editdate').val(),
                'name': $('#Editname').val(),
                'password': $('#Editpassword').val(),
                // 'roles': $("#" + stepid + "ro").text(),
            }
            $.ajax("http://localhost:8080/admin/userlist/" + JSONObject.name, {
                type: "PUT",
                cache: false,
                data: JSON.stringify(JSONObject),
                contentType: "application/json",
                dataType: 'json',
                processData: false,
                async: true,
                success: function () {
                    console.log("done put")
                },
                error: function (jqXHR) {
                    alert(jqXHR.status + ' ' + jqXHR.responseText)
                }
            })
            RestGetList()
        }

        function RESTDelete () {
            RestGetList();
            console.log(stepid)
            $.ajax("http://localhost:8080/admin/userlist/" + $("#" + stepid + "un").text(), {
                type: "DELETE",
                dataType: 'json',
                processData: false,
                async: true,
                success: function () {
                    console.log("deleted")
                },
                error: function (jqXHR) {
                    alert(jqXHR.status + ' ' + jqXHR.responseText);
                }
            })
            RestGetList()
        }

        RestGetList()
        RestGetUser()

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>
</html>